name: Release Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        type: string
      create-tag:
        description: 'Create git tag for this version'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Validate Package

    outputs:
      version: ${{ steps.get-version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.2
          extensions: dom, curl, libxml, mbstring, zip
          coverage: none

      - name: Install dependencies
        run: composer update --prefer-dist --no-interaction

      - name: Run tests
        run: vendor/bin/phpunit --testdox

      - name: Validate composer.json
        run: composer validate --strict

      - name: Check package files
        run: |
          echo "üì¶ Checking required package files..."
          required_files=("README.md" "LICENSE" "CHANGELOG.md" "composer.json")

          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing required file: $file"
              exit 1
            fi
            echo "‚úÖ Found: $file"
          done

      - name: Get version from tag or input
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üìå Version: $VERSION"

      - name: Verify CHANGELOG has version
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! grep -q "\[$VERSION\]" CHANGELOG.md; then
            echo "‚ö†Ô∏è  Warning: CHANGELOG.md does not contain version $VERSION"
            echo "Please update CHANGELOG.md before releasing"
          else
            echo "‚úÖ CHANGELOG.md contains version $VERSION"
          fi

  create-tag:
    needs: validate
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.create-tag == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and push tag
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          git tag -a "v$VERSION" -m "Release version $VERSION"
          git push origin "v$VERSION"
          echo "‚úÖ Created and pushed tag v$VERSION"

  release:
    needs: validate
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          echo "Extracting changelog for version $VERSION"

          # Extract section between [VERSION] and next version or end
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[.*\]/{if(/## \[.*\]/ && !/## \[$VERSION\]/)exit;print}" CHANGELOG.md | tail -n +2)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release version $VERSION"
          fi

          # Save to file for multiline content
          echo "$CHANGELOG" > /tmp/changelog.txt
          echo "changelog-file=/tmp/changelog.txt" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "v${{ needs.validate.outputs.version }}"
          body_path: ${{ steps.changelog.outputs.changelog-file }}
          draft: false
          prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Packagist Update
        if: secrets.PACKAGIST_TOKEN != ''
        run: |
          echo "üì¶ Triggering Packagist update..."

          RESPONSE=$(curl -X POST \
            -H "Content-Type: application/json" \
            -d '{"repository":{"url":"https://github.com/rcommerz/logger-laravel"}}' \
            "https://packagist.org/api/update-package?username=islam_maruf&apiToken=${{ secrets.PACKAGIST_TOKEN }}" \
            -s -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "202" ]; then
            echo "‚úÖ Packagist update triggered successfully!"
            echo "$BODY"
          else
            echo "‚ö†Ô∏è  Packagist API returned status: $HTTP_CODE"
            echo "$BODY"
            echo "Packagist may still auto-update via webhook"
          fi
        continue-on-error: true

      - name: Notify Packagist (Fallback)
        if: secrets.PACKAGIST_TOKEN == ''
        run: |
          echo "üì¶ Package released!"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo ""
          echo "‚ö†Ô∏è  PACKAGIST_TOKEN not configured"
          echo "Packagist will auto-update via GitHub webhook (if configured)"
          echo "Or manually update at: https://packagist.org/packages/rcommerz/logger-laravel"

  verify:
    needs: [validate, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Wait for Packagist update
        run: |
          echo "‚è≥ Waiting 60 seconds for Packagist to sync..."
          sleep 60

      - name: Create test Laravel project
        run: |
          composer create-project laravel/laravel test-app --prefer-dist
          cd test-app

      - name: Test package installation
        run: |
          cd test-app
          composer require rcommerz/logger-laravel:^${{ needs.validate.outputs.version }}

          if [ $? -eq 0 ]; then
            echo "‚úÖ Package successfully installed from Packagist"
          else
            echo "‚ö†Ô∏è  Package not yet available on Packagist"
            echo "This is normal - it may take a few minutes to propagate"
          fi
        continue-on-error: true

      - name: Final status
        run: |
          echo "üéâ Release completed!"
          echo "Version: ${{ needs.validate.outputs.version }}"
          echo "GitHub: https://github.com/rcommerz/logger-laravel/releases/tag/v${{ needs.validate.outputs.version }}"
          echo "Packagist: https://packagist.org/packages/rcommerz/logger-laravel"
